function s3_gis_dropdown_select(e,d){var a=$("#gis_location_L"+e).val();if(a||d){if(e==s3_gis_maxlevel){var b=s3_gis_url+"/search.json?filter=%3D&field=level&value=nullnone&parent="+a}else{var b=s3_gis_url+"/search.json?filter=%3D&field=level&value=L"+(e+1)+"&parent="+a}var c=function(k,f){var h;var g="";if(k.length==0){h=s3_gis_empty_set}else{h=s3_gis_select_location;for(var j=0;j<k.length;j++){g=k[j].id;h+='<option value="'+k[j].id+'">'+k[j].name+"</option>"}}if(e==s3_gis_maxlevel){$("#gis_location_").html(h)}else{$("#gis_location_L"+(e+1)).html(h)}};$.getJSONS3(b,c,false,d);if(e==s3_gis_maxlevel){if(options==s3_gis_empty_set){}else{$("#gis_location_").removeClass("hidden").show();$("#gis_location_label_").removeClass("hidden").show();$("#gis_location_details-btn").removeClass("hidden").show()}}else{$("#gis_location_L"+(e+1)).removeClass("hidden").show();$("#gis_location_label_L"+(e+1)).removeClass("hidden").show();$("#gis_location_details-btn").removeClass("hidden").show()}s3_gis_dropdown_hide(e+2);if(""==$("#gis_location_name").val()){$("#"+s3_gis_location_id).val(a)}}else{s3_gis_dropdown_hide(e+1);if((0==e)&&(""==$("#gis_location_name").val())){$("#"+s3_gis_location_id).val("")}}}function s3_gis_dropdown_hide(a){for(l=a;l<=parseInt(s3_gis_maxlevel);l=l+1){$("#gis_location_L"+l).hide().html(s3_gis_loading_locations);$("#gis_location_label_L"+l).hide()}if(a<(parseInt(s3_gis_maxlevel)+2)){$("#gis_location_").hide().html(s3_gis_loading_locations);$("#gis_location_label_").hide();$("#gis_location_details-btn").hide()}}function s3_gis_save_location(b,c,e,g,f){var d=$("#gis_location_L5").val();if(undefined==d||""==d){d=$("#gis_location_L4").val();if(undefined==d||""==d){d=$("#gis_location_L3").val();if(undefined==d||""==d){d=$("#gis_location_L2").val();if(undefined==d||""==d){d=$("#gis_location_L1").val();if(undefined==d||""==d){d=$("#gis_location_L0").val()}}}}}var a;if(""==S3.gis.uuid){a=s3_gis_url+"/create.url?name="+b}else{a=s3_gis_url+"/update.url?uuid="+S3.gis.uuid+"&name="+b}if(""==c||""==e){}else{a=a+"&lat="+c+"&lon="+e}if(""==g){}else{a=a+"&addr_street="+g.replace(/\n/g,"%0d")}if(""==f){}else{a=a+"&addr_postcode="+f}if(undefined==d||""==d){}else{a=a+"&parent="+d}$.ajax({async:false,url:a,dataType:"json",success:function(i){if((""==S3.gis.uuid)&&(i.status=="success")){var h=i.message.split("=")[1];$("#"+s3_gis_location_id).val(h)}}})}function s3_gis_geolocate(a){var b=a.coords.latitude;var c=a.coords.longitude;$("#gis_location_lat").val(b);$("#gis_location_lon").val(c)}var s3_gis_calcDone=false;var s3_gis_calcAnswer;function s3_gis_convertDD(){var d=$("#DDMMSS_deg").val();var b=$("#DDMMSS_min").val();var c=$("#DDMMSS_sec").val();var e=false;if(d==""){d=0}else{if(isNaN(d)||d>180||d<-180){alert(s3_gis_degrees_validation_error);e=true}}if(b==""){b=0}else{if(isNaN(b)||b>60||b<0){alert(s3_gis_minutes_validation_error);e=true}}if(c==""){c=0}else{if(isNaN(c)||c>60||c<0){alert(s3_gis_seconds_validation_error);e=true}}if(e==false){var a=(b*1+(c/60));if(d>0){s3_gis_calcAnswer=d*1+(a/60)}else{s3_gis_calcAnswer=d*1-(a/60)}$("#DDMMSS_dec").val(s3_gis_calcAnswer);s3_gis_calcDone=true}}function s3_gis_convertGps(){var b=0;var a=0;b=$("#gps_deg").val();a=$("#gps_min").val();var c=false;if(b==""){b=0}else{if(isNaN(b)||b>180||b<-180){alert(s3_gis_degrees_validation_error);c=true}}if(a==""){a=0}else{if(isNaN(a)||a>60||a<0){alert(s3_gis_minutes_validation_error);c=true}}if(c==false){if(b>0){s3_gis_calcAnswer=(b*1)+a/60}else{s3_gis_calcAnswer=(b*1)-a/60}$("#gps_dec").val(s3_gis_calcAnswer);s3_gis_calcDone=true}}function s3_gis_convertFillBack(a){if(s3_gis_calcDone==true){if(a==1){$("#gis_location_lat").attr("value",s3_gis_calcAnswer)}else{$("#gis_location_lon").attr("value",s3_gis_calcAnswer)}return true}else{alert(s3_gis_no_calculations_error)}return false}$(function(){if(typeof(s3_gis_location_id)=="undefined"){}else{$("#gis_location_L0").change(function(){s3_gis_dropdown_select(0)});$("#gis_location_L1").change(function(){s3_gis_dropdown_select(1)});$("#gis_location_L2").change(function(){s3_gis_dropdown_select(2)});$("#gis_location_L3").change(function(){s3_gis_dropdown_select(3)});$("#gis_location_L4").change(function(){s3_gis_dropdown_select(4)});$("#gis_location_").change(function(){var b=$(this).val();if(""==$("#gis_location_name").val()){$("#"+s3_gis_location_id).val(b)}});$("#gis_location_add-btn").click(function(){if(""!=S3.gis.uuid){$("body").data("uuid",S3.gis.uuid);S3.gis.uuid=""}var b=$("#gis_location_lat").val();var c=$("#gis_location_lat").val();if((""!=b)||(""!=c)){$("body").data("lat",b);$("body").data("lon",c);$("#gis_location_lat").val("");$("#gis_location_lon").val("")}$("#gis_location_add-btn").hide();$("#gis_location_cancel-btn").removeClass("hidden").show();$("#gis_location_").hide();$("#gis_location_label_").hide();if(navigator.geolocation){$("#gis_location_geolocate-btn").removeClass("hidden").show()}else{}$("#gis_location_map-btn").removeClass("hidden").show();$("#gis_location_name_label").removeClass("hidden").show();$("#gis_location_name").removeClass("hidden").show();$("#gis_location_addr_street_label").removeClass("hidden").show();$("#gis_location_addr_street_row").removeClass("hidden").show();$("#gis_location_postcode_label").removeClass("hidden").show();$("#gis_location_postcode_row").removeClass("hidden").show();$("#gis_location_advanced_div").removeClass("hidden").show()});$("#gis_location_advanced_checkbox").change(function(){if($("#gis_location_advanced_checkbox").is(":checked")){$("#gis_location_lat_label").removeClass("hidden").show();$("#gis_location_lat_row").removeClass("hidden").show();$("#gis_location_lon_label").removeClass("hidden").show();$("#gis_location_lon_row").removeClass("hidden").show()}else{$("#gis_location_lat_label").hide();$("#gis_location_lat_row").hide();$("#gis_location_lon_label").hide();$("#gis_location_lon_row").hide()}});$("#gis_location_search-btn").click(function(){$(this).hide();$("#gis_location_autocomplete_div").removeClass("hidden").show()});$("#gis_location_details-btn").click(function(){$("#gis_location_map-btn").removeClass("hidden").show();$("#gis_location_addr_street_label").removeClass("hidden").show();$("#gis_location_addr_street_row").removeClass("hidden").show();$("#gis_location_postcode_label").removeClass("hidden").show();$("#gis_location_postcode_row").removeClass("hidden").show();$("#gis_location_advanced_div").removeClass("hidden").show()});$("#gis_location_cancel-btn").click(function(){S3.gis.uuid=$("body").data("uuid");$("#gis_location_lat").val($("body").data("lat"));$("#gis_location_lon").val($("body").data("lon"));$("#gis_location_cancel-btn").hide();$("#gis_location_name").val("");$("#gis_location_add-btn").show();if(""!=$("#gis_location_").val()){$("#gis_location_").show();$("#gis_location_label_").show();$("#gis_location_details-btn").show()}$("#gis_location_map-btn").hide();$("#gis_location_name_label").hide();$("#gis_location_name").hide();$("#gis_location_addr_street_label").hide();$("#gis_location_addr_street_row").hide();$("#gis_location_postcode_label").hide();$("#gis_location_postcode_row").hide();$("#gis_location_advanced_div").hide()});$("#gis_location_geolocate-btn").click(function(){navigator.geolocation.getCurrentPosition(s3_gis_geolocate)});var a={val:$("#gis_location_autocomplete").val(),accept:false};$("#gis_location_autocomplete").autocomplete({source:s3_gis_url+"/search.json?filter=~&field=name&exclude_field=level&exclude_value=XX",minLength:2,focus:function(b,c){$("#gis_location_autocomplete").val(c.item.name);return false},select:function(b,j){$("#gis_location_autocomplete").val(j.item.name);$("#"+s3_gis_location_id).val(j.item.id);a.accept=true;var c=j.item.path;var e=j.item.id;var i,h,g,f,d;var k=[];switch(j.item.level){case"L0":$("#gis_location_L0").val(e);s3_gis_dropdown_select(0);break;case"L1":if(c){c=c.split("/");if(c.length==2&&c[1]==e){$("#gis_location_L0").val(c[0])}}s3_gis_dropdown_select(0,true);$("#gis_location_L1").val(e);s3_gis_dropdown_select(1);break;case"L2":if(c){c=c.split("/");if(c.length==3&&c[2]==e){$("#gis_location_L0").val(c[0]);i=c[1]}else{if(c.length==2&&c[1]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0])}else{i=c[0]}}}}s3_gis_dropdown_select(0,true);$("#gis_location_L1").val(i);s3_gis_dropdown_select(1,true);$("#gis_location_L2").val(e);s3_gis_dropdown_select(2);break;case"L3":if(c){c=c.split("/");if(c.length==4&&c[3]==e){$("#gis_location_L0").val(c[0]);i=c[1];h=c[2]}else{if(c.length==3&&c[2]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1]]}else{i=c[0];h=c[1]}}else{if(c.length==2&&c[1]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0])}else{k=[c[0]]}}}}}s3_gis_dropdown_select(0,true);if(k[0]){if(undefined!=$("#gis_location_L1 option[value="+k[0]+"]")[0]){i=k[0]}}$("#gis_location_L1").val(i);s3_gis_dropdown_select(1,true);if(k[0]){if(undefined!=$("#gis_location_L2 option[value="+k[0]+"]")[0]){h=k[0]}}$("#gis_location_L2").val(h);s3_gis_dropdown_select(2,true);$("#gis_location_L3").val(e);s3_gis_dropdown_select(3);break;case"L4":if(c){c=c.split("/");if(c.length==5&&c[4]==e){$("#gis_location_L0").val(c[0]);i=c[1];h=c[2];g=c[3]}else{if(c.length==4&&c[3]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1],c[2]]}else{k=[c[0],c[1],c[2]]}}else{if(c.length==3&&c[2]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1]]}else{k=[c[0],c[1]]}}else{if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0])}else{k=[c[0]]}}}}}s3_gis_dropdown_select(0,true);if(k[0]){if(undefined!=$("#gis_location_L1 option[value="+k[0]+"]")[0]){i=k[0]}}$("#gis_location_L1").val(i);s3_gis_dropdown_select(1,true);if(k[0]){if(undefined!=$("#gis_location_L2 option[value="+k[0]+"]")[0]){h=k[0]}else{if(k[1]){if(undefined!=$("#gis_location_L2 option[value="+k[1]+"]")[0]){h=k[1]}}}}$("#gis_location_L2").val(h);s3_gis_dropdown_select(2,true);if(k[0]){if(undefined!=$("#gis_location_L3 option[value="+k[0]+"]")[0]){g=k[0]}else{if(k[1]){if(undefined!=$("#gis_location_L3 option[value="+k[1]+"]")[0]){g=k[1]}else{if(k[2]){if(undefined!=$("#gis_location_L3 option[value="+k[2]+"]")[0]){g=k[2]}}}}}}$("#gis_location_L3").val(g);s3_gis_dropdown_select(3,true);$("#gis_location_L4").val(e);s3_gis_dropdown_select(4);break;case"L5":break;default:if(c){c=c.split("/");if(c.length==6&&c[5]==e){$("#gis_location_L0").val(c[0]);i=c[1];h=c[2];g=c[3];g=c[4]}else{if(c.length==5&&c[4]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1],c[2],c[3]]}else{k=[c[0],c[1],c[2],c[3]]}}else{if(c.length==4&&c[3]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1],c[2]]}else{k=[c[0],c[1],c[2]]}}else{if(c.length==3&&c[2]==e){if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0]);k=[c[1]]}else{k=[c[0],c[1]]}}else{if(undefined!=$("#gis_location_L0 option[value="+c[0]+"]")[0]){$("#gis_location_L0").val(c[0])}else{k=[c[0]]}}}}}}s3_gis_dropdown_select(0,true);if(k[0]){if(undefined!=$("#gis_location_L1 option[value="+k[0]+"]")[0]){i=k[0]}}$("#gis_location_L1").val(i);s3_gis_dropdown_select(1,true);if(k[0]){if(undefined!=$("#gis_location_L2 option[value="+k[0]+"]")[0]){h=k[0]}else{if(k[1]){if(undefined!=$("#gis_location_L2 option[value="+k[1]+"]")[0]){h=k[1]}}}}$("#gis_location_L2").val(h);s3_gis_dropdown_select(2,true);if(k[0]){if(undefined!=$("#gis_location_L3 option[value="+k[0]+"]")[0]){g=k[0]}else{if(k[1]){if(undefined!=$("#gis_location_L3 option[value="+k[1]+"]")[0]){g=k[1]}else{if(k[2]){if(undefined!=$("#gis_location_L3 option[value="+k[2]+"]")[0]){g=k[2]}}}}}}$("#gis_location_L3").val(g);s3_gis_dropdown_select(3);if(k[0]){if(undefined!=$("#gis_location_L4 option[value="+k[0]+"]")[0]){f=k[0]}else{if(k[1]){if(undefined!=$("#gis_location_L4 option[value="+k[1]+"]")[0]){f=k[1]}else{if(k[2]){if(undefined!=$("#gis_location_L4 option[value="+k[2]+"]")[0]){f=k[2]}else{if(k[3]){if(undefined!=$("#gis_location_L4 option[value="+k[4]+"]")[0]){f=k[3]}}}}}}}}$("#gis_location_L4").val(f);s3_gis_dropdown_select(4,true);$("#gis_location_").val(e)}$("#gis_location_autocomplete_div").hide();$("#gis_location_search-btn").show();return false}}).data("autocomplete")._renderItem=function(b,c){return $("<li></li>").data("item.autocomplete",c).append("<a>"+c.name+"</a>").appendTo(b)};$("#gis_location_autocomplete").blur(function(){if(!$("#gis_location_autocomplete").val()){$("#"+s3_gis_location_id).val("");a.accept=true}if(!a.accept){$("#gis_location_autocomplete").val(a.val)}else{a.val=$("#gis_location_autocomplete").val()}a.accept=false});$("form").submit(function(){S3ClearNavigateAwayConfirm();var b=$("#gis_location_name").val();var c=$("#gis_location_lat").val();var d=$("#gis_location_lon").val();var f=$("#gis_location_addr_street").val();var e=$("#gis_location_postcode").val();if(""==b){if((""==c||""==d)&&(""==f)&&(""==e)){return true}else{b=$("#gis_location_ :selected").text();if(""==b){return true}else{if((S3.gis.lat==$("#gis_location_lat").val())&&(S3.gis.lon==$("#gis_location_lon").val())&&(S3.gis.addr_street==$("#gis_location_addr_street").val().replace(/\n/g,"%0d"))&&(S3.gis.postcode==$("#gis_location_postcode").val())){}else{s3_gis_save_location(b,c,d,f,e)}return true}}}s3_gis_save_location(b,c,d,f,e);return true})}});Ext.onReady(function(){var b;var a=Ext.get("gis_location_converter-btn");var c=Ext.get("gis_location_map-btn");if(c){c.on("click",function(){mapWin.show(this)})}if(a){a.on("click",function(){if(!b){b=new Ext.Window({applyTo:"gis-convert-win",layout:"fit",width:400,height:250,closeAction:"hide",plain:true,items:new Ext.TabPanel({applyTo:"gis-convert-tabs",autoTabs:true,activeTab:0,deferredRender:false,border:false}),buttons:[{text:s3_gis_fill_lat,disabled:false,handler:function(){if(s3_gis_convertFillBack(1)){s3_gis_calcDone=false;$("#DDMMSS_dec").val("");$("#gps_dec").val("")}}},{text:s3_gis_fill_lon,handler:function(){if(s3_gis_convertFillBack(2)){s3_gis_calcDone=false;$("#DDMMSS_dec").val("");$("#gps_dec").val("")}}}]})}b.show(this)})}});