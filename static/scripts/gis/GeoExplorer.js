OpenLayers.Projection.addTransform("EPSG:4326","EPSG:102113",OpenLayers.Layer.SphericalMercator.projectForward);OpenLayers.Projection.addTransform("EPSG:102113","EPSG:4326",OpenLayers.Layer.SphericalMercator.projectInverse);var GeoExplorer=Ext.extend(gxp.Viewer,{zoomSliderText:"<div>Zoom Level: {zoom}</div><div>Scale: 1:{scale}</div>",loadConfigErrorText:"Trouble reading saved configuration: <br />",loadConfigErrorDefaultText:"Server Error.",xhrTroubleText:"Communication Trouble: Status ",addLayersText:"Add Layers",removeLayerText:"Remove Layer",layersText:"Layers",overlaysText:"Overlays",baseLayersText:"Base Layers",layerPropertiesText:"Layer Properties",zoomToLayerExtentText:"Zoom to Layer Extent",legendText:"Legend",abstractTemplateText:"<p><b>Abstract:</b> {abstract}</p>",titleText:"Title",idText:"Id",viewDataText:"View available data from:",addServerText:"Add a New Server",layerSourceDefaultTitleText:"Untitled",addLayerSourceError1Text:"Error getting WMS capabilities (",addLayerSourceError2Text:").\nPlease check the url and try again.",availableLayersText:"Available Layers",addLayersText:"Add Layers",doneText:"Done",zoomLevelText:"Zoom level",zoomPreviousText:"Zoom to Previous Extent",zoomNextText:"Zoom to Next Extent",featureInfoText:"Get Feature Info",switch3dText:"Switch to 3D Viewer",previewText:"Print Preview",printText:"Print Map",notAllNotPrintableText:"Not All Layers Can Be Printed",nonePrintableText:"None of your current map layers can be printed",someNotPrintableText:"Some map layers cannot be printed: ",featureInfoText:"Feature Info",saveErrorText:"Trouble saving: ",bookmarkText:"Bookmark URL",permakinkText:'Permalink',appInfoText:"GeoExplorer",aboutText:"About GeoExplorer",mapInfoText:"Map Info",descriptionText:"Description",contactText:"Contact",aboutThisMapText:"About this Map",mapPanel:null,alignToGrid:false,capGrid:null,constructor:function(config){this.mapItems=[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:this.zoomSliderText})}];this.toggleGroup='toolGroup';config.tools=[{ptype:"gxp_panmap",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:6}},{ptype:"gx_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:7}},{ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:8}},{ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:9}},{ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:11}},{ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:13}}];GeoExplorer.superclass.constructor.apply(this,arguments);},loadConfig:function(config){var mapUrl=window.location.hash.substr(1);var match=mapUrl.match(/^maps\/(\d+)$/);if(match){this.id=Number(match[1]);OpenLayers.Request.GET({url:mapUrl,success:function(request){var addConfig=Ext.util.JSON.decode(request.responseText);this.applyConfig(Ext.applyIf(addConfig,config));},failure:function(request){var obj;try{obj=Ext.util.JSON.decode(request.responseText);}catch(err){}
var msg=this.loadConfigErrorText;if(obj&&obj.error){msg+=obj.error;}else{msg+=this.loadConfigErrorDefaultText;}
this.on({ready:function(){this.displayXHRTrouble(msg,request.status);},scope:this});delete this.id;window.location.hash="";this.applyConfig(config);},scope:this});}else{var query=Ext.urlDecode(document.location.search.substr(1));if(query&&query.q){var queryConfig=Ext.util.JSON.decode(query.q);Ext.apply(config,queryConfig);}
this.applyConfig(config);}},displayXHRTrouble:function(msg,status){Ext.Msg.show({title:this.xhrTroubleText+status,msg:msg,icon:Ext.MessageBox.WARNING});},initPortal:function(){var mapOverlay=this.createMapOverlay();this.mapPanel.add(mapOverlay);var addLayerButton=new Ext.Button({tooltip:this.addLayersText,disabled:true,iconCls:"icon-addlayers",handler:this.showCapabilitiesGrid,scope:this});this.on("ready",function(){addLayerButton.enable();});var getRecordFromNode=function(node){if(node&&node.layer){var layer=node.layer;var store=node.layerStore;record=store.getAt(store.findBy(function(r){return r.get("layer")===layer;}));}
return record;};var getSelectedLayerRecord=function(){var node=layerTree.getSelectionModel().getSelectedNode();return getRecordFromNode(node);};var removeLayerAction=new Ext.Action({text:this.removeLayerText,iconCls:"icon-removelayers",disabled:true,tooltip:this.removeLayerText,handler:function(){var record=getSelectedLayerRecord();if(record){this.mapPanel.layers.remove(record);removeLayerAction.disable();}},scope:this});var treeRoot=new Ext.tree.TreeNode({text:this.layersText,expanded:true,isTarget:false,allowDrop:false});treeRoot.appendChild(new GeoExt.tree.LayerContainer({text:this.baseLayersText,iconCls:"gx-folder",expanded:true,group:"background",loader:new GeoExt.tree.LayerLoader({baseAttrs:{checkedGroup:"background"},store:this.mapPanel.layers,filter:function(record){return record.get("group")==="background"&&record.get("layer").displayInLayerSwitcher==true;},createNode:function(attr){var layer=attr.layer;var store=attr.layerStore;if(layer&&store){var record=store.getAt(store.findBy(function(r){return r.get("layer")===layer;}));if(record){if(!record.get("queryable")){attr.iconCls="gx-tree-rasterlayer-icon";}
if(record.get("fixed")){attr.allowDrag=false;}}}
return GeoExt.tree.LayerLoader.prototype.createNode.apply(this,arguments);}}),singleClickExpand:true,allowDrag:false,listeners:{append:function(tree,node){node.expand();}}}));treeRoot.appendChild(new GeoExt.tree.LayerContainer({text:this.overlaysText,iconCls:"gx-folder",expanded:true,loader:new GeoExt.tree.LayerLoader({store:this.mapPanel.layers,filter:function(record){return!record.get("group")&&record.get("layer").displayInLayerSwitcher==true;},createNode:function(attr){var layer=attr.layer;var store=attr.layerStore;if(layer&&store){var record=store.getAt(store.findBy(function(r){return r.get("layer")===layer;}));if(record&&!record.get("queryable")){attr.iconCls="gx-tree-rasterlayer-icon";}}
return GeoExt.tree.LayerLoader.prototype.createNode.apply(this,[attr]);}}),singleClickExpand:true,allowDrag:false,listeners:{append:function(tree,node){node.expand();}}}));this.treeRoot=treeRoot;var layerPropertiesDialog;var showPropertiesAction=new Ext.Action({text:this.layerPropertiesText,iconCls:"icon-properties",disabled:true,tooltip:this.layerPropertiesText,handler:function(){var record=getSelectedLayerRecord();if(record){var type=record.get("properties");if(type){if(layerPropertiesDialog){layerPropertiesDialog.close();}
layerPropertiesDialog=new Ext.Window({title:this.layerPropertiesText+": "+record.get("title"),width:250,height:250,layout:"fit",items:[{xtype:type,layerRecord:record,defaults:{style:"padding: 10px"}}]});layerPropertiesDialog.show();}}},scope:this});var updateLayerActions=function(sel,node){if(node&&node.layer){var count=this.mapPanel.layers.queryBy(function(r){return!(r.get("layer")instanceof OpenLayers.Layer.Vector);}).getCount();if(count>1){removeLayerAction.enable();}else{removeLayerAction.disable();}
var record=getRecordFromNode(node);if(record.get("properties")){showPropertiesAction.enable();}else{showPropertiesAction.disable();}}else{removeLayerAction.disable();showPropertiesAction.disable();}};var layerTree=new Ext.tree.TreePanel({root:treeRoot,rootVisible:false,border:false,enableDD:true,selModel:new Ext.tree.DefaultSelectionModel({listeners:{beforeselect:updateLayerActions,scope:this}}),listeners:{contextmenu:function(node,e){if(node&&node.layer){node.select();var c=node.getOwnerTree().contextMenu;c.contextNode=node;c.showAt(e.getXY());}},beforemovenode:function(tree,node,oldParent,newParent,index){if(oldParent!==newParent){var store=newParent.loader.store;var index=store.findBy(function(r){return r.getLayer()===node.layer;});if(index>-1){store.getAt(index).set("group",newParent.attributes.group);}}},scope:this},contextMenu:new Ext.menu.Menu({items:[{text:this.zoomToLayerExtentText,iconCls:"icon-zoom-to",handler:function(){var node=layerTree.getSelectionModel().getSelectedNode();if(node&&node.layer){var map=this.mapPanel.map;var layer=node.layer;var extent=layer.restrictedExtent||layer.maxExtent||map.maxExtent;map.zoomToExtent(extent,true);}},scope:this},removeLayerAction,showPropertiesAction]})});var layersContainer=new Ext.Panel({autoScroll:true,border:false,region:'center',title:this.layersText,items:[layerTree],tbar:[addLayerButton,Ext.apply(new Ext.Button(removeLayerAction),{text:""}),Ext.apply(new Ext.Button(showPropertiesAction),{text:""})]});var legendContainer=new GeoExt.LegendPanel({title:this.legendText,border:false,region:'south',height:200,collapsible:true,split:true,autoScroll:true,ascending:false,map:this.mapPanel.map,defaults:{cls:'legend-item'}});var westPanel=new Ext.Panel({border:true,layout:"border",region:"west",width:250,split:true,collapsible:true,collapseMode:"mini",items:[layersContainer,legendContainer]});this.toolbar=new Ext.Toolbar({disabled:true,id:'paneltbar',items:this.createTools()});this.on("ready",function(){var disabled=this.toolbar.items.filterBy(function(item){return item.initialConfig&&item.initialConfig.disabled;});this.toolbar.enable();disabled.each(function(item){item.disable();});});var googleEarthPanel=new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(record){return record.get("group")!=="background";}}});googleEarthPanel.on("show",function(){if(layersContainer.rendered){layersContainer.getTopToolbar().disable();}
layerTree.getSelectionModel().un("beforeselect",updateLayerActions,this);},this);googleEarthPanel.on("hide",function(){if(layersContainer.rendered){layersContainer.getTopToolbar().enable();}
var sel=layerTree.getSelectionModel();var node=sel.getSelectedNode();updateLayerActions.apply(this,[sel,node]);sel.on("beforeselect",updateLayerActions,this);},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,googleEarthPanel],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer,westPanel]}];GeoExplorer.superclass.initPortal.apply(this,arguments);},initCapGrid:function(){var source,data=[];for(var id in this.layerSources){source=this.layerSources[id];if(source.store){data.push([id,this.layerSources[id].title||id]);}}
var sources=new Ext.data.ArrayStore({fields:["id","title"],data:data});var expander=new Ext.grid.RowExpander({tpl:new Ext.Template(this.abstractTemplateText)});var addLayers=function(){var key=sourceComboBox.getValue();var layerStore=this.mapPanel.layers;var source=this.layerSources[key];var records=capGridPanel.getSelectionModel().getSelections();var record;for(var i=0,ii=records.length;i<ii;++i){record=source.createLayerRecord({name:records[i].get("name"),source:key});if(record){if(record.get("group")==="background"){layerStore.insert(0,[record]);}else{layerStore.add([record]);}}}};var capGridPanel=new Ext.grid.GridPanel({store:this.layerSources[data[0][0]].store,layout:"fit",region:"center",autoScroll:true,autoExpandColumn:"title",plugins:[expander],colModel:new Ext.grid.ColumnModel([expander,{id:"title",header:this.titleText,dataIndex:"title",sortable:true},{header:this.idText,dataIndex:"name",width:150,sortable:true}]),listeners:{rowdblclick:addLayers,scope:this}});var sourceComboBox=new Ext.form.ComboBox({store:sources,valueField:"id",displayField:"title",triggerAction:"all",editable:false,allowBlank:false,forceSelection:true,mode:"local",value:data[0][0],listeners:{select:function(combo,record,index){var store=this.layerSources[record.get("id")].store;capGridPanel.reconfigure(store,capGridPanel.getColumnModel());capGridPanel.getView().focusRow(0);},scope:this}});var capGridToolbar=null;if(this.proxy||data.length>1){capGridToolbar=[new Ext.Toolbar.TextItem({text:this.viewDataText}),sourceComboBox];}
if(this.proxy){capGridToolbar.push("-",new Ext.Button({text:this.addServerText,iconCls:"icon-addserver",handler:function(){newSourceWindow.show();}}));}
var newSourceWindow=new GeoExplorer.NewSourceWindow({modal:true,listeners:{"server-added":function(url){newSourceWindow.setLoading();this.addLayerSource({config:{url:url},callback:function(id){var record=new sources.recordType({id:id,title:this.layerSources[id].title||this.layerSourceDefaultTitleText});sources.insert(0,[record]);sourceComboBox.onSelect(record,0);newSourceWindow.hide();},fallback:function(source,msg){newSourceWindow.setError(this.addLayerSourceError1Text+msg+this.addLayerSourceError2Text);},scope:this});},scope:this}});this.capGrid=new Ext.Window({title:this.availableLayersText,closeAction:"hide",layout:"border",height:300,width:450,modal:true,items:[capGridPanel],tbar:capGridToolbar,bbar:["->",new Ext.Button({text:this.addLayersText,iconCls:"icon-addlayers",handler:addLayers,scope:this}),new Ext.Button({text:this.doneText,handler:function(){this.capGrid.hide();},scope:this})],listeners:{hide:function(win){capGridPanel.getSelectionModel().clearSelections();}}});},showCapabilitiesGrid:function(){if(!this.capGrid){this.initCapGrid();}
this.capGrid.show();},createMapOverlay:function(){var scaleLinePanel=new Ext.BoxComponent({autoEl:{tag:"div",cls:"olControlScaleLine overlay-element overlay-scaleline"}});scaleLinePanel.on('render',function(){var scaleLine=new OpenLayers.Control.ScaleLine({div:scaleLinePanel.getEl().dom});this.mapPanel.map.addControl(scaleLine);scaleLine.activate();},this);var zoomStore=new GeoExt.data.ScaleStore({map:this.mapPanel.map});var zoomSelector=new Ext.form.ComboBox({emptyText:this.zoomLevelText,tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:'all',mode:'local',store:zoomStore,width:110});zoomSelector.on({click:function(evt){evt.stopEvent();},mousedown:function(evt){evt.stopEvent();},select:function(combo,record,index){this.mapPanel.map.zoomTo(record.data.level);},scope:this})
var zoomSelectorWrapper=new Ext.Panel({items:[zoomSelector],cls:'overlay-element overlay-scalechooser',border:false});this.mapPanel.map.events.register('zoomend',this,function(){var scale=zoomStore.queryBy(function(record){return this.mapPanel.map.getZoom()==record.data.level;},this);if(scale.length>0){scale=scale.items[0];zoomSelector.setValue("1 : "+parseInt(scale.data.scale,10));}else{if(!zoomSelector.rendered){return;}
zoomSelector.clearValue();}});var mapOverlay=new Ext.Panel({cls:'map-overlay',items:[scaleLinePanel,zoomSelectorWrapper]});mapOverlay.on("afterlayout",function(){scaleLinePanel.getEl().dom.style.position='relative';scaleLinePanel.getEl().dom.style.display='inline';mapOverlay.getEl().on("click",function(x){x.stopEvent();});mapOverlay.getEl().on("mousedown",function(x){x.stopEvent();});},this);return mapOverlay;},createTools:function(){var toolGroup=this.toggleGroup;var enable3DButton=new Ext.Button({iconCls:"icon-3D",tooltip:this.switch3dText,enableToggle:true,toggleHandler:function(button,state){if(state===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();button.enable();}else{this.mapPanelContainer.getLayout().setActiveItem(0);this.toolbar.enable();}},scope:this});var tools=[this.printService&&this.createPrintButton()||"-","-",enable3DButton];return tools;},createPrintButton:function(){var printProvider=new GeoExt.data.PrintProvider({url:this.printService,listeners:{beforeprint:function(){printWindow.items.get(0).printMapPanel.layers.each(function(l){var params=l.get("layer").params;for(var p in params){if(params[p]instanceof Array){params[p]=params[p].join(",");}}})},loadcapabilities:function(){printButton.initialConfig.disabled=false;printButton.disabled=false;printButton.enable();},print:function(){try{printWindow.close();}catch(err){}}}});var unsupportedLayers;var printWindow;var someSupportedLayers;function destroyPrintComponents(){if(printWindow){try{var panel=printWindow.items.first();panel.printMapPanel.printPage.destroy();}catch(err){}
printWindow=null;}}
function createPrintWindow(){someSupportedLayers=false;unsupportedLayers=[];printWindow=new Ext.Window({title:this.previewText,modal:true,border:false,resizable:false,width:360,items:[new GeoExt.ux.PrintPreview({autoHeight:true,mapTitle:this.about["title"],comment:this.about["abstract"],printMapPanel:{map:Ext.applyIf({controls:[new OpenLayers.Control.Navigation(),new OpenLayers.Control.PanPanel(),new OpenLayers.Control.ZoomPanel(),new OpenLayers.Control.Attribution()],eventListeners:{preaddlayer:function(evt){if(!(evt.layer instanceof OpenLayers.Layer.WMS)&&!(evt.layer instanceof OpenLayers.Layer.OSM)){if(evt.layer.CLASS_NAME!=="OpenLayers.Layer"){unsupportedLayers.push(evt.layer.name);}
return false;}else{someSupportedLayers=true;}},scope:this}},this.mapPanel.initialConfig.map),items:[{xtype:"gx_zoomslider",vertical:true,height:100,aggressive:true}]},printProvider:printProvider,includeLegend:false,sourceMap:this.mapPanel})],listeners:{beforedestroy:destroyPrintComponents}});}
function showPrintWindow(){printWindow.show();printWindow.setWidth(0);var tb=printWindow.items.get(0).items.get(0);var w=0;tb.items.each(function(item){if(item.getEl()){w+=item.getWidth();}});printWindow.setWidth(Math.max(printWindow.items.get(0).printMapPanel.getWidth(),w+20));printWindow.center();}
var printButton=new Ext.Button({tooltip:this.printText,iconCls:"icon-print",disabled:true,handler:function(){createPrintWindow.call(this);if(!someSupportedLayers){Ext.Msg.alert(this.notAllPrintableText,this.nonePrintableText);destroyPrintComponents();}else{if(unsupportedLayers.length){Ext.Msg.alert(this.notAllPrintableText,this.someNotPrintableText+"<ul><li>"+unsupportedLayers.join("</li><li>")+"</li></ul>",showPrintWindow,this);}else{showPrintWindow.call(this);}}},scope:this});return printButton;},save:function(callback,scope){var configStr=Ext.util.JSON.encode(this.getState());var method,url;if(this.id){method="PUT";url="maps/"+this.id;}else{method="POST";url="maps"}
OpenLayers.Request.issue({method:method,url:url,data:configStr,callback:function(request){this.handleSave(request);if(callback){callback.call(scope||this);}},scope:this});},handleSave:function(request){if(request.status==200){var config=Ext.util.JSON.decode(request.responseText);var mapId=config.id;if(mapId){this.id=mapId;window.location.hash="#maps/"+mapId;}}else{throw this.saveErrorText+request.responseText;}},showUrl:function(){var win=new Ext.Window({title:this.bookmarkText,layout:'form',labelAlign:'top',modal:true,bodyStyle:"padding: 5px",width:300,items:[{xtype:'textfield',fieldLabel:this.permakinkText,readOnly:true,anchor:"100%",selectOnFocus:true,value:window.location.href}]});win.show();win.items.first().selectText();},getBookmark:function(){var params=Ext.apply(OpenLayers.Util.getParameters(),{q:Ext.util.JSON.encode(this.getState())});var url=document.location.href.split("?").shift()+"?"+Ext.urlEncode(params);return url;},displayAppInfo:function(){var appInfo=new Ext.Panel({title:this.appInfoText,html:"<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+this.aboutText+"</a> </iframe>"});var about=Ext.applyIf(this.about,{title:'',"abstract":'',contact:''});var mapInfo=new Ext.Panel({title:this.mapInfoText,html:'<div class="gx-info-panel">'+'<h2>'+this.titleText+'</h2><p>'+about.title+'</p><h2>'+this.descriptionText+'</h2><p>'+about['abstract']+'</p> <h2>'+this.contactText+'</h2><p>'+about.contact+'</p></div>',height:'auto',width:'auto'});var tabs=new Ext.TabPanel({activeTab:0,items:[mapInfo,appInfo]});var win=new Ext.Window({title:this.aboutThisMapText,modal:true,layout:"fit",width:300,height:300,items:[tabs]});win.show();}});GeoExplorer.Composer=Ext.extend(GeoExplorer,{publishMapText:"Publish Map",saveMapText:"Save Map",mapSizeText:"Map Size",miniText:"Mini",smallText:"Small",largeText:"Large",heightText:"Height",widthText:"Width",exportMapText:"Export Map",embedText:"Your map is ready to be published to the web! Simply copy the following HTML to embed the map in your website:",createTools:function(){var tools=GeoExplorer.Composer.superclass.createTools.apply(this,arguments);var aboutButton=new Ext.Button({text:this.appInfoText,iconCls:"icon-geoexplorer",handler:this.displayAppInfo,scope:this});tools.unshift("-");tools.unshift(new Ext.Button({tooltip:this.publishMapText,handler:function(){this.save(this.showEmbedWindow);},scope:this,iconCls:'icon-export'}));tools.unshift(new Ext.Button({tooltip:this.saveMapText,handler:function(){this.save(this.showUrl);},scope:this,iconCls:"icon-save"}));tools.unshift("-");tools.unshift(aboutButton);return tools;},showEmbedWindow:function(){var obj=OpenLayers.Util.createUrlObject("geoexplorer/viewer.html");var port=(obj.port==="80")?"":":"+obj.port;var url=obj.protocol+"//"+obj.host+port+obj.pathname+"#maps/"+this.id;var snippetArea=new Ext.form.TextArea({height:70,selectOnFocus:true,readOnly:true});var updateSnippet=function(){snippetArea.setValue('<iframe height="'+heightField.getValue()+' " width="'+widthField.getValue()+'" src="'+url+'"> </iframe>');};var heightField=new Ext.form.NumberField({width:50,value:400,listeners:{change:updateSnippet}});var widthField=new Ext.form.NumberField({width:50,value:600,listeners:{change:updateSnippet}});var adjustments=new Ext.Container({layout:"column",defaults:{border:false,xtype:"box"},items:[{autoEl:{cls:"gx-field-label",html:this.mapSizeText}},new Ext.form.ComboBox({editable:false,width:70,store:new Ext.data.SimpleStore({fields:["name","height","width"],data:[[this.miniText,100,100],[this.smallText,200,300],[this.largeText,400,600]]}),triggerAction:'all',displayField:'name',value:this.largeText,mode:'local',listeners:{select:function(combo,record,index){widthField.setValue(record.get("width"));heightField.setValue(record.get("height"));updateSnippet();}}}),{autoEl:{cls:"gx-field-label",html:this.heightText}},heightField,{autoEl:{cls:"gx-field-label",html:this.widthText}},widthField]});var win=new Ext.Window({height:205,width:350,modal:true,title:this.exportMapText,layout:"fit",items:[{xtype:"container",border:false,defaults:{border:false,cls:"gx-export-section",xtype:"container",layout:"fit"},items:[{xtype:"box",autoEl:{tag:"p",html:this.embedText}},{items:[snippetArea]},{items:[adjustments]}]}],listeners:{afterrender:updateSnippet}});win.show();}});Ext.namespace("GeoExplorer");GeoExplorer.NewSourceWindow=Ext.extend(Ext.Window,{title:"Add New Web Map Service (WMS) ...",urlText:"URL",cancelText:"Cancel",addServerText:"Add Server",contactingServerText:"Contacting Server...",bodyStyle:"padding: 0px",width:300,closeAction:'hide',error:null,initComponent:function(){this.addEvents("server-added");this.urlTextField=new Ext.form.TextField({fieldLabel:this.urlText,width:240,msgTarget:"under",validator:OpenLayers.Function.bind(function(){return(this.error==null)?true:this.error;},this)});this.form=new Ext.form.FormPanel({items:[this.urlTextField],border:false,labelWidth:30,bodyStyle:"padding: 5px",autoWidth:true,autoHeight:true});this.bbar=[new Ext.Button({text:this.cancelText,handler:function(){this.hide();},scope:this}),new Ext.Toolbar.Fill(),new Ext.Button({text:this.addServerText,iconCls:"icon-addlayers",handler:function(){this.error=null;this.urlTextField.validate();this.fireEvent("server-added",this.urlTextField.getValue());},scope:this})];this.items=this.form;GeoExplorer.NewSourceWindow.superclass.initComponent.call(this);this.form.on("render",function(){this.loadMask=new Ext.LoadMask(this.form.getEl(),{msg:this.contactingServerText});},this);this.on("hide",function(){this.error=null;this.urlTextField.validate();this.urlTextField.setValue("");this.loadMask.hide();},this);},setLoading:function(){this.loadMask.show();},setError:function(error){this.loadMask.hide();this.error=error;this.urlTextField.validate();}});Ext.namespace("GeoExplorer");GeoExplorer.Viewer=Ext.extend(GeoExplorer,{initPortal:function(){var mapOverlay=this.createMapOverlay();this.mapPanel.add(mapOverlay);this.toolbar=new Ext.Toolbar({disabled:true,items:this.createTools()});this.on("ready",function(){this.toolbar.enable();},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(record){return record.get("group")!=="background";}}})],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer]}];GeoExplorer.superclass.initPortal.apply(this,arguments);},createTools:function(){var tools=GeoExplorer.Viewer.superclass.createTools.apply(this,arguments);var layerChooser=new Ext.Button({tooltip:'Layer Switcher',iconCls:'icon-layer-switcher',menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})});tools.unshift("-");tools.unshift(layerChooser);var aboutButton=new Ext.Button({tooltip:this.aboutText,iconCls:"icon-about",handler:this.displayAppInfo,scope:this});tools.push("->");tools.push(aboutButton);return tools;}});GeoExplorer.SahanaComposer=Ext.extend(GeoExplorer.Composer,{createOverviewMap:function(){var proj4326=new OpenLayers.Projection('EPSG:4326');var options={projection:this.mapPanel.map.projection,theme:null,units:this.mapPanel.map.units,maxResolution:this.mapPanel.map.maxResolution,maxExtent:this.mapPanel.map.maxExtent,numZoomLevels:this.mapPanel.map.numZoomLevels};var overviewMap=new OpenLayers.Control.OverviewMap({mapOptions:options});this.mapPanel.map.addControl(overviewMap);},createTools:function(){var tools=GeoExplorer.SahanaComposer.superclass.createTools.apply(this,arguments);var geoLocateButton=new Ext.Button({iconCls:"geolocation",tooltip:"Zoom to Current Location",handler:function(){navigator.geolocation.getCurrentPosition(this.zoomCurrentPosition);},scope:this});if(navigator.geolocation){tools.push("-");tools.push(geoLocateButton);}else{}
return tools;},zoomCurrentPosition:function(position){var proj4326=new OpenLayers.Projection('EPSG:4326');var zoomLevel=15;var lat=position.coords.latitude;var lon=position.coords.longitude;window.s3_gis_app.mapPanel.map.setCenter(new OpenLayers.LonLat(lon,lat).transform(proj4326,window.s3_gis_app.mapPanel.map.getProjectionObject()),zoomLevel);}});