var GeoExplorer=Ext.extend(gxp.Viewer,{zoomSliderText:"<div>Zoom Level: {zoom}</div><div>Scale: 1:{scale}</div>",loadConfigErrorText:"Trouble reading saved configuration: <br />",loadConfigErrorDefaultText:"Server Error.",xhrTroubleText:"Communication Trouble: Status ",layersText:"Layers",titleText:"Title",zoomLevelText:"Zoom level",switch3dText:"Switch to 3D Viewer",saveErrorText:"Trouble saving: ",bookmarkText:"Bookmark URL",permakinkText:'Permalink',appInfoText:"GeoExplorer",aboutText:"About GeoExplorer",mapInfoText:"Map Info",descriptionText:"Description",contactText:"Contact",aboutThisMapText:"About this Map",mapPanel:null,toggleGroup:"toolGroup",constructor:function(config){this.mapItems=[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:this.zoomSliderText})}];config.viewerTools=[{leaf:true,text:gxp.plugins.Navigation.prototype.tooltip,checked:true,iconCls:"gxp-icon-pan",ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:2}},{leaf:true,text:gxp.plugins.WMSGetFeatureInfo.prototype.infoActionTip,checked:true,iconCls:"gxp-icon-getfeatureinfo",ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:3}},{leaf:true,text:gxp.plugins.Measure.prototype.measureTooltip,checked:true,iconCls:"gxp-icon-measure-length",ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:4}},{leaf:true,text:gxp.plugins.Zoom.prototype.zoomInTooltip+" / "+gxp.plugins.Zoom.prototype.zoomOutTooltip,checked:true,iconCls:"gxp-icon-zoom-in",ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:5}},{leaf:true,text:gxp.plugins.NavigationHistory.prototype.previousTooltip+" / "+gxp.plugins.NavigationHistory.prototype.nextTooltip,checked:true,iconCls:"gxp-icon-zoom-previous",ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:7}},{leaf:true,text:gxp.plugins.ZoomToExtent.prototype.tooltip,checked:true,iconCls:gxp.plugins.ZoomToExtent.prototype.iconCls,ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:9}},{leaf:true,text:gxp.plugins.Legend.prototype.tooltip,checked:true,iconCls:"gxp-icon-legend",ptype:"gxp_legend",actionTarget:{target:"paneltbar",index:10}}];GeoExplorer.superclass.constructor.apply(this,arguments);},loadConfig:function(config){var mapUrl=window.location.hash.substr(1);var match=mapUrl.match(/^maps\/(\d+)$/);if(match){this.id=Number(match[1]);OpenLayers.Request.GET({url:mapUrl,success:function(request){var addConfig=Ext.util.JSON.decode(request.responseText);this.applyConfig(Ext.applyIf(addConfig,config));},failure:function(request){var obj;try{obj=Ext.util.JSON.decode(request.responseText);}catch(err){}
var msg=this.loadConfigErrorText;if(obj&&obj.error){msg+=obj.error;}else{msg+=this.loadConfigErrorDefaultText;}
this.on({ready:function(){this.displayXHRTrouble(msg,request.status);},scope:this});delete this.id;window.location.hash="";this.applyConfig(config);},scope:this});}else{var query=Ext.urlDecode(document.location.search.substr(1));if(query&&query.q){var queryConfig=Ext.util.JSON.decode(query.q);Ext.apply(config,queryConfig);}
this.applyConfig(config);}},displayXHRTrouble:function(msg,status){Ext.Msg.show({title:this.xhrTroubleText+status,msg:msg,icon:Ext.MessageBox.WARNING});},initPortal:function(){var mapOverlay=this.createMapOverlay();this.mapPanel.add(mapOverlay);var mapSearch=new GeoExt.ux.GeoNamesSearchCombo({map:this.mapPanel.map,zoom:12});var searchCombo=new Ext.Panel({id:'searchCombo',title:this.geonamesText,border:false,layout:'border',region:'north',rootVisible:false,height:48,lines:false,html:'',items:[{region:'center',items:[mapSearch]}]});var westPanel=new Ext.Panel({border:false,layout:"border",region:"west",width:250,split:true,collapsible:true,collapseMode:"mini",header:false,items:[{region:'center',border:false,id:'tree',tbar:[],title:this.layersText},searchCombo,{region:'south',border:false,height:200,id:'legend'}]});this.toolbar=new Ext.Toolbar({disabled:true,id:'paneltbar',items:this.createTools()});this.on("ready",function(){var disabled=this.toolbar.items.filterBy(function(item){return item.initialConfig&&item.initialConfig.disabled;});this.toolbar.enable();disabled.each(function(item){item.disable();});});var googleEarthPanel=new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(record){return record.get("group")!=="background";}}});googleEarthPanel.on("show",function(){var layersContainer=Ext.getCmp('layertree');if(layersContainer&&layersContainer.getTopToolbar()){layersContainer.getTopToolbar().setDisabled(true);}},this);googleEarthPanel.on("hide",function(){var layersContainer=Ext.getCmp('layertree');if(layersContainer&&layersContainer.getTopToolbar()){layersContainer.getTopToolbar().setDisabled(false);}},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,googleEarthPanel],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer,westPanel]}];GeoExplorer.superclass.initPortal.apply(this,arguments);},createMapOverlay:function(){var scaleLinePanel=new Ext.BoxComponent({autoEl:{tag:"div",cls:"olControlScaleLine overlay-element overlay-scaleline"}});scaleLinePanel.on('render',function(){var scaleLine=new OpenLayers.Control.ScaleLine({div:scaleLinePanel.getEl().dom});this.mapPanel.map.addControl(scaleLine);scaleLine.activate();},this);var zoomStore=new GeoExt.data.ScaleStore({map:this.mapPanel.map});var zoomSelector=new Ext.form.ComboBox({emptyText:this.zoomLevelText,tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:'all',mode:'local',store:zoomStore,width:110});zoomSelector.on({click:function(evt){evt.stopEvent();},mousedown:function(evt){evt.stopEvent();},select:function(combo,record,index){this.mapPanel.map.zoomTo(record.data.level);},scope:this});var zoomSelectorWrapper=new Ext.Panel({items:[zoomSelector],cls:'overlay-element overlay-scalechooser',border:false});this.mapPanel.map.events.register('zoomend',this,function(){var scale=zoomStore.queryBy(function(record){return this.mapPanel.map.getZoom()==record.data.level;},this);if(scale.length>0){scale=scale.items[0];zoomSelector.setValue("1 : "+parseInt(scale.data.scale,10));}else{if(!zoomSelector.rendered){return;}
zoomSelector.clearValue();}});var mapOverlay=new Ext.Panel({cls:'map-overlay',items:[scaleLinePanel,zoomSelectorWrapper]});mapOverlay.on("afterlayout",function(){scaleLinePanel.getEl().dom.style.position='relative';scaleLinePanel.getEl().dom.style.display='inline';mapOverlay.getEl().on("click",function(x){x.stopEvent();});mapOverlay.getEl().on("mousedown",function(x){x.stopEvent();});},this);return mapOverlay;},createTools:function(){var toolGroup=this.toggleGroup;var enable3DButton=new Ext.Button({iconCls:"icon-3D",tooltip:this.switch3dText,enableToggle:true,toggleHandler:function(button,state){if(state===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();button.enable();}else{this.mapPanelContainer.getLayout().setActiveItem(0);this.toolbar.enable();}},scope:this});var tools=["-",enable3DButton];return tools;},save:function(callback,scope){var configStr=Ext.util.JSON.encode(this.getState());var method,url;if(this.id){method="PUT";url="maps/"+this.id;}else{method="POST";url="maps";}
OpenLayers.Request.issue({method:method,url:url,data:configStr,callback:function(request){this.handleSave(request);if(callback){callback.call(scope||this);}},scope:this});},handleSave:function(request){if(request.status==200){var config=Ext.util.JSON.decode(request.responseText);var mapId=config.id;if(mapId){this.id=mapId;window.location.hash="#maps/"+mapId;}}else{throw this.saveErrorText+request.responseText;}},showUrl:function(){var win=new Ext.Window({title:this.bookmarkText,layout:'form',labelAlign:'top',modal:true,bodyStyle:"padding: 5px",width:300,items:[{xtype:'textfield',fieldLabel:this.permakinkText,readOnly:true,anchor:"100%",selectOnFocus:true,value:window.location.href}]});win.show();win.items.first().selectText();},getBookmark:function(){var params=Ext.apply(OpenLayers.Util.getParameters(),{q:Ext.util.JSON.encode(this.getState())});var url=document.location.href.split("?").shift()+"?"+Ext.urlEncode(params);return url;},displayAppInfo:function(){var appInfo=new Ext.Panel({title:this.appInfoText,html:"<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+this.aboutText+"</a> </iframe>"});var about=Ext.applyIf(this.about,{title:'','abstract':'',contact:''});var mapInfo=new Ext.Panel({title:this.mapInfoText,html:'<div class="gx-info-panel">'+'<h2>'+this.titleText+'</h2><p>'+about.title+'</p><h2>'+this.descriptionText+'</h2><p>'+about['abstract']+'</p> <h2>'+this.contactText+'</h2><p>'+about.contact+'</p></div>',height:'auto',width:'auto'});var tabs=new Ext.TabPanel({activeTab:0,items:[mapInfo,appInfo]});var win=new Ext.Window({title:this.aboutThisMapText,modal:true,layout:'fit',width:300,height:300,items:[tabs]});win.show();}});GeoExplorer.Composer=Ext.extend(GeoExplorer,{saveMapText:"Save Map",exportMapText:"Export Map",toolsTitle:"Choose tools to include in the toolbar:",previewText:"Preview",backText:"Back",nextText:"Next",constructor:function(config){config.tools=[{ptype:"gxp_layertree",outputConfig:{id:"layertree",tbar:[]},outputTarget:"tree"},{ptype:"gxp_legend",outputTarget:'legend'},{ptype:"gxp_addlayers",actionTarget:"layertree.tbar",upload:true},{ptype:"gxp_removelayer",actionTarget:["layertree.tbar","layertree.contextMenu"]},{ptype:"gxp_layerproperties",actionTarget:["layertree.tbar","layertree.contextMenu"]},{ptype:"gxp_zoomtolayerextent",actionTarget:{target:"layertree.contextMenu",index:0}},{ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:6}},{ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:7}},{ptype:"gxp_featuremanager",id:"featuremanager",maxFeatures:20},{ptype:"gxp_featureeditor",featureManager:"featuremanager",autoLoadFeatures:true,toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:8}},{ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:10}},{ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:11}},{ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:13}},{ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:15}},{ptype:"gxp_print",printService:config.printService,actionTarget:{target:"paneltbar",index:5}}];GeoExplorer.Composer.superclass.constructor.apply(this,arguments);},createTools:function(){var tools=GeoExplorer.Composer.superclass.createTools.apply(this,arguments);var aboutButton=new Ext.Button({text:this.appInfoText,iconCls:"icon-geoexplorer",handler:this.displayAppInfo,scope:this});tools.unshift("-");tools.unshift(new Ext.Button({tooltip:this.exportMapText,handler:function(){this.save(this.showEmbedWindow);},scope:this,iconCls:'icon-export'}));tools.unshift(new Ext.Button({tooltip:this.saveMapText,handler:function(){this.save(this.showUrl);},scope:this,iconCls:"icon-save"}));tools.unshift("-");tools.unshift(aboutButton);return tools;},openPreview:function(){window.open("viewer.html"+"#maps/"+this.id);},showEmbedWindow:function(){var toolsArea=new Ext.tree.TreePanel({title:this.toolsTitle,autoScroll:true,root:{nodeType:'async',expanded:true,children:this.viewerTools},rootVisible:false,id:'geobuilder-0'});var previousNext=function(incr){var l=Ext.getCmp('geobuilder-wizard-panel').getLayout();var i=l.activeItem.id.split('geobuilder-')[1];var next=parseInt(i,10)+incr;l.setActiveItem(next);Ext.getCmp('wizard-prev').setDisabled(next==0);Ext.getCmp('wizard-next').setDisabled(next==1);if(incr==1){this.save();}};var wizard={id:'geobuilder-wizard-panel',layout:'card',activeItem:0,defaults:{border:false,hideMode:'offsets'},bbar:[{id:'preview',text:this.previewText,handler:function(){this.save(this.openPreview);},scope:this},'->',{id:'wizard-prev',text:this.backText,handler:previousNext.createDelegate(this,[-1]),scope:this,disabled:true},{id:'wizard-next',text:this.nextText,handler:previousNext.createDelegate(this,[1]),scope:this}],items:[toolsArea,{id:'geobuilder-1',xtype:"gxp_embedmapdialog",url:"viewer.html"+"#maps/"+this.id}]};new Ext.Window({width:500,height:300,title:this.exportMapText,items:[wizard]}).show();}});Ext.namespace("GeoExplorer");GeoExplorer.Viewer=Ext.extend(GeoExplorer,{applyConfig:function(config){var allTools=config.viewerTools||this.viewerTools;var tools=[];for(var i=0,len=allTools.length;i<len;i++){var tool=allTools[i];if(tool.checked===true){tools.push({ptype:tool.ptype,toggleGroup:tool.toggleGroup,actionTarget:tool.actionTarget});}}
config.tools=tools;GeoExplorer.Viewer.superclass.applyConfig.call(this,config);},initPortal:function(){var mapOverlay=this.createMapOverlay();this.mapPanel.add(mapOverlay);this.toolbar=new Ext.Toolbar({disabled:true,id:"paneltbar",items:this.createTools()});this.on("ready",function(){this.toolbar.enable();},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(record){return record.get("group")!=="background";}}})],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer]}];GeoExplorer.superclass.initPortal.apply(this,arguments);},createTools:function(){var tools=GeoExplorer.Viewer.superclass.createTools.apply(this,arguments);var layerChooser=new Ext.Button({tooltip:'Layer Switcher',iconCls:'icon-layer-switcher',menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})});tools.unshift("-");tools.unshift(layerChooser);var aboutButton=new Ext.Button({tooltip:this.aboutText,iconCls:"icon-about",handler:this.displayAppInfo,scope:this});tools.push("->");tools.push(aboutButton);return tools;}});GeoExplorer.SahanaComposer=Ext.extend(GeoExplorer.Composer,{geoLocateButtonText:"Zoom to Current Location",potlatchButtonText:"Edit the OpenStreetMap data for this area",potlatchUrl:'/eden/gis/potlatch2/potlatch2.html',createOverviewMap:function(){var proj4326=new OpenLayers.Projection('EPSG:4326');var options={projection:this.mapPanel.map.projection,theme:null,units:this.mapPanel.map.units,maxResolution:this.mapPanel.map.maxResolution,maxExtent:this.mapPanel.map.maxExtent,numZoomLevels:this.mapPanel.map.numZoomLevels};var overviewMap=new OpenLayers.Control.OverviewMap({mapOptions:options});this.mapPanel.map.addControl(overviewMap);},createTools:function(){var tools=GeoExplorer.SahanaComposer.superclass.createTools.apply(this,arguments);var proj4326=new OpenLayers.Projection('EPSG:4326');var potlatchButton=new Ext.Button({iconCls:'potlatch',tooltip:this.potlatchButtonText,handler:function(){var map=s3_gis_app.mapPanel.map;var lonlat=this.mapPanel.map.getCenter();var zoom_current=this.mapPanel.map.getZoom();if(zoom_current<14){zoom_current=14;}
lonlat.transform(this.mapPanel.map.getProjectionObject(),proj4326);var url=this.potlatchUrl+'?lat='+lonlat.lat+'&lon='+lonlat.lon+'&zoom='+zoom_current;window.open(url);},scope:this})
tools.push(potlatchButton);var geoLocateButton=new Ext.Button({iconCls:"geolocation",tooltip:this.geoLocateButtonText,handler:function(){navigator.geolocation.getCurrentPosition(this.zoomToCurrentPosition);},scope:this});if(navigator.geolocation){tools.push(geoLocateButton);}else{}
return tools;},zoomToCurrentPosition:function(position){var proj4326=new OpenLayers.Projection('EPSG:4326');var zoomLevel=15;var lat=position.coords.latitude;var lon=position.coords.longitude;window.s3_gis_app.mapPanel.map.setCenter(new OpenLayers.LonLat(lon,lat).transform(proj4326,window.s3_gis_app.mapPanel.map.getProjectionObject()),zoomLevel);}});