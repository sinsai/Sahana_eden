Ext.USE_NATIVE_JSON=true;
var GeoExplorer=Ext.extend(gxp.Viewer,{zoomSliderText:"<div>Zoom Level: {zoom}</div><div>Scale: 1:{scale}</div>",loadConfigErrorText:"Trouble reading saved configuration: <br />",loadConfigErrorDefaultText:"Server Error.",xhrTroubleText:"Communication Trouble: Status ",layersText:"Layers",titleText:"Title",zoomLevelText:"Zoom level",switch3dText:"Switch to 3D Viewer",saveErrorText:"Trouble saving: ",bookmarkText:"Bookmark URL",permakinkText:"Permalink",appInfoText:"GeoExplorer",aboutText:"About GeoExplorer",
mapInfoText:"Map Info",descriptionText:"Description",contactText:"Contact",aboutThisMapText:"About this Map",mapPanel:null,toggleGroup:"toolGroup",constructor:function(a){this.mapItems=[{xtype:"gx_zoomslider",vertical:true,height:100,plugins:new GeoExt.ZoomSliderTip({template:this.zoomSliderText})}];a.viewerTools=[{leaf:true,text:gxp.plugins.Navigation.prototype.tooltip,checked:true,iconCls:"gxp-icon-pan",ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:2}},
{leaf:true,text:gxp.plugins.WMSGetFeatureInfo.prototype.infoActionTip,checked:true,iconCls:"gxp-icon-getfeatureinfo",ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:3}},{leaf:true,text:gxp.plugins.Measure.prototype.measureTooltip,checked:true,iconCls:"gxp-icon-measure-length",ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:4}},{leaf:true,text:gxp.plugins.Zoom.prototype.zoomInTooltip+" / "+gxp.plugins.Zoom.prototype.zoomOutTooltip,
checked:true,iconCls:"gxp-icon-zoom-in",ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:5}},{leaf:true,text:gxp.plugins.NavigationHistory.prototype.previousTooltip+" / "+gxp.plugins.NavigationHistory.prototype.nextTooltip,checked:true,iconCls:"gxp-icon-zoom-previous",ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:7}},{leaf:true,text:gxp.plugins.ZoomToExtent.prototype.tooltip,checked:true,iconCls:gxp.plugins.ZoomToExtent.prototype.iconCls,ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",
index:9}},{leaf:true,text:gxp.plugins.Legend.prototype.tooltip,checked:true,iconCls:"gxp-icon-legend",ptype:"gxp_legend",actionTarget:{target:"paneltbar",index:10}}];GeoExplorer.superclass.constructor.apply(this,arguments)},loadConfig:function(a){var b=window.location.hash.substr(1),c=b.match(/^maps\/(\d+)$/);if(c){this.id=Number(c[1]);OpenLayers.Request.GET({url:b,success:function(e){e=Ext.util.JSON.decode(e.responseText);this.applyConfig(Ext.applyIf(e,a))},failure:function(e){var f;try{f=Ext.util.JSON.decode(e.responseText)}catch(d){}var g=
this.loadConfigErrorText;g+=f&&f.error?f.error:this.loadConfigErrorDefaultText;this.on({ready:function(){this.displayXHRTrouble(g,e.status)},scope:this});delete this.id;window.location.hash="";this.applyConfig(a)},scope:this})}else{if((b=Ext.urlDecode(document.location.search.substr(1)))&&b.q){b=Ext.util.JSON.decode(b.q);Ext.apply(a,b)}this.applyConfig(a)}},displayXHRTrouble:function(a,b){Ext.Msg.show({title:this.xhrTroubleText+b,msg:a,icon:Ext.MessageBox.WARNING})},initPortal:function(){this.mapPanel.add(this.createMapOverlay());
var a=new GeoExt.ux.GeoNamesSearchCombo({map:this.mapPanel.map,zoom:12});a=new Ext.Panel({id:"searchCombo",title:this.geonamesText,border:false,layout:"border",region:"north",rootVisible:false,height:48,lines:false,html:"",items:[{region:"center",items:[a]}]});a=new Ext.Panel({border:false,layout:"border",region:"west",width:250,split:true,collapsible:true,collapseMode:"mini",header:false,items:[{region:"center",autoScroll:true,tbar:[],border:false,id:"tree",title:this.layersText},a,{region:"south",
xtype:"container",layout:"fit",border:false,height:200,id:"legend"}]});this.toolbar=new Ext.Toolbar({disabled:true,id:"paneltbar",items:this.createTools()});this.on("ready",function(){var c=this.toolbar.items.filterBy(function(e){return e.initialConfig&&e.initialConfig.disabled});this.toolbar.enable();c.each(function(e){e.disable()})});var b=new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(c){return c.get("group")!=="background"}}});b.on("show",function(){var c=Ext.getCmp("layertree");
c&&c.getTopToolbar()&&c.getTopToolbar().setDisabled(true)},this);b.on("hide",function(){var c=Ext.getCmp("layertree");c&&c.getTopToolbar()&&c.getTopToolbar().setDisabled(false)},this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,b],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer,a]}];GeoExplorer.superclass.initPortal.apply(this,arguments)},createMapOverlay:function(){var a=
new Ext.BoxComponent({autoEl:{tag:"div",cls:"olControlScaleLine overlay-element overlay-scaleline"}});a.on("render",function(){var d=new OpenLayers.Control.ScaleLine({div:a.getEl().dom});this.mapPanel.map.addControl(d);d.activate()},this);var b=new GeoExt.data.ScaleStore({map:this.mapPanel.map}),c=new Ext.form.ComboBox({emptyText:this.zoomLevelText,tpl:'<tpl for="."><div class="x-combo-list-item">1 : {[parseInt(values.scale)]}</div></tpl>',editable:false,triggerAction:"all",mode:"local",store:b,width:110});
c.on({click:function(d){d.stopEvent()},mousedown:function(d){d.stopEvent()},select:function(d,g){this.mapPanel.map.zoomTo(g.data.level)},scope:this});var e=new Ext.Panel({items:[c],cls:"overlay-element overlay-scalechooser",border:false});this.mapPanel.map.events.register("zoomend",this,function(){var d=b.queryBy(function(g){return this.mapPanel.map.getZoom()==g.data.level},this);if(d.length>0){d=d.items[0];c.setValue("1 : "+parseInt(d.data.scale,10))}else c.rendered&&c.clearValue()});var f=new Ext.Panel({cls:"map-overlay",
items:[a,e]});f.on("afterlayout",function(){a.getEl().dom.style.position="relative";a.getEl().dom.style.display="inline";f.getEl().on("click",function(d){d.stopEvent()});f.getEl().on("mousedown",function(d){d.stopEvent()})},this);return f},createTools:function(){return["-",new Ext.Button({iconCls:"icon-3D",tooltip:this.switch3dText,enableToggle:true,toggleHandler:function(a,b){if(b===true){this.mapPanelContainer.getLayout().setActiveItem(1);this.toolbar.disable();a.enable()}else{this.mapPanelContainer.getLayout().setActiveItem(0);
this.toolbar.enable()}},scope:this})]},save:function(a,b){var c=Ext.util.JSON.encode(this.getState()),e,f;if(this.id){e="PUT";f="maps/"+this.id}else{e="POST";f="maps"}OpenLayers.Request.issue({method:e,url:f,data:c,callback:function(d){this.handleSave(d);if(a)a.call(b||this)},scope:this})},handleSave:function(a){if(a.status==200){if(a=Ext.util.JSON.decode(a.responseText).id){this.id=a;window.location.hash="#maps/"+a}}else throw this.saveErrorText+a.responseText;},showUrl:function(){var a=new Ext.Window({title:this.bookmarkText,
layout:"form",labelAlign:"top",modal:true,bodyStyle:"padding: 5px",width:300,items:[{xtype:"textfield",fieldLabel:this.permakinkText,readOnly:true,anchor:"100%",selectOnFocus:true,value:window.location.href}]});a.show();a.items.first().selectText()},getBookmark:function(){var a=Ext.apply(OpenLayers.Util.getParameters(),{q:Ext.util.JSON.encode(this.getState())});return document.location.href.split("?").shift()+"?"+Ext.urlEncode(a)},displayAppInfo:function(){var a=new Ext.Panel({title:this.appInfoText,
html:"<iframe style='border: none; height: 100%; width: 100%' src='about.html' frameborder='0' border='0'><a target='_blank' href='about.html'>"+this.aboutText+"</a> </iframe>"}),b=Ext.applyIf(this.about,{title:"","abstract":"",contact:""});b=new Ext.Panel({title:this.mapInfoText,html:'<div class="gx-info-panel"><h2>'+this.titleText+"</h2><p>"+b.title+"</p><h2>"+this.descriptionText+"</h2><p>"+b["abstract"]+"</p> <h2>"+this.contactText+"</h2><p>"+b.contact+"</p></div>",height:"auto",width:"auto"});
a=new Ext.TabPanel({activeTab:0,items:[b,a]});(new Ext.Window({title:this.aboutThisMapText,modal:true,layout:"fit",width:300,height:300,items:[a]})).show()}});
GeoExplorer.Composer=Ext.extend(GeoExplorer,{saveMapText:"Save Map",exportMapText:"Export Map",toolsTitle:"Choose tools to include in the toolbar:",previewText:"Preview",backText:"Back",nextText:"Next",constructor:function(a){a.tools=[{ptype:"gxp_layertree",outputConfig:{id:"layertree"},outputTarget:"tree"},{ptype:"gxp_legend",outputTarget:"legend",outputConfig:{autoScroll:true}},{ptype:"gxp_addlayers",actionTarget:"tree.tbar",upload:true},{ptype:"gxp_removelayer",actionTarget:["tree.tbar","layertree.contextMenu"]},
{ptype:"gxp_layerproperties",actionTarget:["tree.tbar","layertree.contextMenu"]},{ptype:"gxp_styler",actionTarget:["tree.tbar","layertree.contextMenu"]},{ptype:"gxp_zoomtolayerextent",actionTarget:{target:"layertree.contextMenu",index:0}},{ptype:"gxp_navigation",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:6}},{ptype:"gxp_wmsgetfeatureinfo",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:7}},{ptype:"gxp_featuremanager",id:"featuremanager",maxFeatures:20},
{ptype:"gxp_featureeditor",featureManager:"featuremanager",autoLoadFeatures:true,toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:8}},{ptype:"gxp_measure",toggleGroup:this.toggleGroup,actionTarget:{target:"paneltbar",index:10}},{ptype:"gxp_zoom",actionTarget:{target:"paneltbar",index:11}},{ptype:"gxp_navigationhistory",actionTarget:{target:"paneltbar",index:13}},{ptype:"gxp_zoomtoextent",actionTarget:{target:"paneltbar",index:15}},{ptype:"gxp_print",printService:a.printService,
actionTarget:{target:"paneltbar",index:5}}];GeoExplorer.Composer.superclass.constructor.apply(this,arguments)},createTools:function(){var a=GeoExplorer.Composer.superclass.createTools.apply(this,arguments),b=new Ext.Button({text:this.appInfoText,iconCls:"icon-geoexplorer",handler:this.displayAppInfo,scope:this});a.unshift("-");a.unshift(new Ext.Button({tooltip:this.exportMapText,handler:function(){this.save(this.showEmbedWindow)},scope:this,iconCls:"icon-export"}));a.unshift(new Ext.Button({tooltip:this.saveMapText,
handler:function(){this.save(this.showUrl)},scope:this,iconCls:"icon-save"}));a.unshift("-");a.unshift(b);return a},openPreview:function(a){a=new Ext.Window({title:this.previewText,layout:"fit",items:[{border:false,html:a.getIframeHTML()}]});a.show();a=a.items.get(0).body;var b=a.dom.firstChild,c=new Ext.LoadMask(a);c.show();Ext.get(b).on("load",function(){c.hide()})},showEmbedWindow:function(){var a=new Ext.tree.TreePanel({title:this.toolsTitle,autoScroll:true,root:{nodeType:"async",expanded:true,
children:this.viewerTools},rootVisible:false,id:"geobuilder-0"}),b=function(e){var f=Ext.getCmp("geobuilder-wizard-panel").getLayout(),d=f.activeItem.id.split("geobuilder-")[1];d=parseInt(d,10)+e;f.setActiveItem(d);Ext.getCmp("wizard-prev").setDisabled(d==0);Ext.getCmp("wizard-next").setDisabled(d==1);e==1&&this.save()},c=new gxp.EmbedMapDialog({id:"geobuilder-1",url:"viewer#maps/"+this.id});a={id:"geobuilder-wizard-panel",border:false,layout:"card",activeItem:0,defaults:{border:false,hideMode:"offsets"},
bbar:[{id:"preview",text:this.previewText,handler:function(){this.save(this.openPreview.createDelegate(this,[c]))},scope:this},"->",{id:"wizard-prev",text:this.backText,handler:b.createDelegate(this,[-1]),scope:this,disabled:true},{id:"wizard-next",text:this.nextText,handler:b.createDelegate(this,[1]),scope:this}],items:[a,c]};(new Ext.Window({layout:"fit",width:500,height:300,title:this.exportMapText,items:[a]})).show()}});Ext.namespace("GeoExplorer");
GeoExplorer.Viewer=Ext.extend(GeoExplorer,{applyConfig:function(a){for(var b=a.viewerTools||this.viewerTools,c=[],e=0,f=b.length;e<f;e++){var d=b[e];d.checked===true&&c.push({ptype:d.ptype,toggleGroup:d.toggleGroup,actionTarget:d.actionTarget})}a.tools=c;GeoExplorer.Viewer.superclass.applyConfig.call(this,a)},initPortal:function(){this.mapPanel.add(this.createMapOverlay());this.toolbar=new Ext.Toolbar({disabled:true,id:"paneltbar",items:this.createTools()});this.on("ready",function(){this.toolbar.enable()},
this);this.mapPanelContainer=new Ext.Panel({layout:"card",region:"center",defaults:{border:false},items:[this.mapPanel,new gxp.GoogleEarthPanel({mapPanel:this.mapPanel,listeners:{beforeadd:function(a){return a.get("group")!=="background"}}})],activeItem:0});this.portalItems=[{region:"center",layout:"border",tbar:this.toolbar,items:[this.mapPanelContainer]}];GeoExplorer.superclass.initPortal.apply(this,arguments)},createTools:function(){var a=GeoExplorer.Viewer.superclass.createTools.apply(this,arguments),
b=new Ext.Button({tooltip:"Layer Switcher",iconCls:"icon-layer-switcher",menu:new gxp.menu.LayerMenu({layers:this.mapPanel.layers})});a.unshift("-");a.unshift(b);b=new Ext.Button({tooltip:this.aboutText,iconCls:"icon-about",handler:this.displayAppInfo,scope:this});a.push("->");a.push(b);return a}});
GeoExplorer.SahanaComposer=Ext.extend(GeoExplorer.Composer,{geoLocateButtonText:"Zoom to Current Location",potlatchButtonText:"Edit the OpenStreetMap data for this area",potlatchUrl:"/eden/gis/potlatch2/potlatch2.html",createOverviewMap:function(){new OpenLayers.Projection("EPSG:4326");this.mapPanel.map.addControl(new OpenLayers.Control.OverviewMap({mapOptions:{projection:this.mapPanel.map.projection,theme:null,units:this.mapPanel.map.units,maxResolution:this.mapPanel.map.maxResolution,maxExtent:this.mapPanel.map.maxExtent,
numZoomLevels:this.mapPanel.map.numZoomLevels}}))},createTools:function(){var a=GeoExplorer.SahanaComposer.superclass.createTools.apply(this,arguments),b=new OpenLayers.Projection("EPSG:4326"),c=new Ext.Button({iconCls:"potlatch",tooltip:this.potlatchButtonText,handler:function(){var e=this.mapPanel.map.getCenter(),f=this.mapPanel.map.getZoom();if(f<14)f=14;e.transform(this.mapPanel.map.getProjectionObject(),b);window.open(this.potlatchUrl+"?lat="+e.lat+"&lon="+e.lon+"&zoom="+f)},scope:this});a.push(c);
c=new Ext.Button({iconCls:"geolocation",tooltip:this.geoLocateButtonText,handler:function(){navigator.geolocation.getCurrentPosition(this.zoomToCurrentPosition)},scope:this});navigator.geolocation&&a.push(c);return a},zoomToCurrentPosition:function(a){var b=new OpenLayers.Projection("EPSG:4326");window.s3_gis_app.mapPanel.map.setCenter((new OpenLayers.LonLat(a.coords.longitude,a.coords.latitude)).transform(b,window.s3_gis_app.mapPanel.map.getProjectionObject()),15)}});
