function USNG2(){var h=["A","B","C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V"],k=["F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","A","B","C","D","E"],r=["A","B","C","D","E","F","G","H"],v=["J","K","L","M","N","P","Q","R"],w=["S","T","U","V","W","X","Y","Z"],z=["C","D","E","F","G","H","J","K","L","M","N","P","Q","R","S","T","U","V","W","X"],D=[-80,-72,-64,-56,-48,-40,-32,-24,-16,-8,0,8,16,24,32,40,48,58,64,72],C=Array(20);for(i=0;i<20;i++)C[i]=110946.259*D[i];
this.llDistance=function(c,e){lat_s=c.lat*Math.PI/180;lat_f=e.lat*Math.PI/180;d_lon=(e.lon-c.lon)*Math.PI/180;return Math.atan2(Math.sqrt(Math.pow(Math.cos(lat_f)*Math.sin(d_lon),2)+Math.pow(Math.cos(lat_s)*Math.sin(lat_f)-Math.sin(lat_s)*Math.cos(lat_f)*Math.cos(d_lon),2)),Math.sin(lat_s)*Math.sin(lat_f)+Math.cos(lat_s)*Math.cos(lat_f)*Math.cos(d_lon))};this.fromUTM=function(c,e,f,m,o){var l;grid_square_set=c%6;ew_idx=Math.floor(f/1E5)-1;ns_idx=Math.floor(m%2E6/1E5);switch(grid_square_set){case 1:l=
r[ew_idx]+h[ns_idx];break;case 2:l=v[ew_idx]+k[ns_idx];break;case 3:l=w[ew_idx]+h[ns_idx];break;case 4:l=r[ew_idx]+k[ns_idx];break;case 5:l=v[ew_idx]+h[ns_idx];break;case 0:l=w[ew_idx]+k[ns_idx];break;default:throw"USNG: can't get here";}for(var b=Math.floor(f%1E5).toString(),a=Math.floor(m%1E5).toString();b.length<5;)b="0"+b;for(;a.length<5;)a="0"+a;if(o>5){digits=o-5;f=b+(f%1).toFixed(digits).substr(2,digits);m=a+(m%1).toFixed(digits).substr(2,digits)}else{f=b.substr(0,o);m=a.substr(0,o)}return usng_string=
String(c)+e+l+f+m};this.toUTMFromFullParsedUSNG=function(c,e,f,m,o,l){var b=0,a=0;switch(c%6){case 1:b=h;a=r;break;case 2:b=k;a=v;break;case 3:b=h;a=w;break;case 4:b=k;a=r;break;case 5:b=h;a=v;break;case 0:b=k;a=w;break;default:throw"Can't get here";}ew_idx=a.indexOf(f[0]);ns_idx=b.indexOf(f[1]);if(ew_idx==-1||ns_idx==-1)throw"USNG: Invalid USNG 100km grid designator.";b=(ew_idx+1)*1E5+m;a=(ns_idx+0)*1E5+o;min_northing=C[z.indexOf(e)];a+=2E6*Math.ceil((min_northing-a)/2E6);ll=utm_proj.invProj(c,b,
a);ll_utm_zone=Math.floor((ll.lon- -180)/6)+1;ll_grid_zone=z[Math.floor((ll.lat- -80)/8)];if(ll_grid_zone!=e){a-=2E6;ll=utm_proj.invProj(c,b,a);ll_utm_zone=Math.floor((ll.lon- -180)/6)+1;ll_grid_zone=z[Math.floor((ll.lat- -80)/8)]}if(ll_utm_zone!=c||ll_grid_zone!=e)throw"USNG: calculated coordinate not in correct UTM or grid zone! Supplied: "+c+e+" Calculated: "+ll_utm_zone+ll_grid_zone;return{zone:c,easting:b,northing:a,precision:l}};this.toUTM=function(c,e){var f=0,m=0,o=0,l=null,b=null,a=null,
d=null;c=c.replace(/ /g,"");re=/([0-9]+)$/;if(fields=re.exec(c)){l=fields[0];o=l.length/2;scale_factor=Math.pow(10,5-o);f=Number(l.substr(0,o))*scale_factor;m=Number(l.substr(o,o))*scale_factor}c=c.substr(0,c.length-o*2);re=/([A-Z][A-Z]$)/;if(fields=re.exec(c))b=fields[0];c=c.substr(0,c.length-2);re=/([0-9]+)([A-Z])/;if(fields=re.exec(c)){d=fields[1];a=fields[2]}if(!(d&&a&&b))if(b&&e){var n=1E3,g=null,j=null;s=Math.floor((e.lon- -180)/6)+1;for(d=s-1;d<=s+1;d++)for(grid_zone_idx=0;grid_zone_idx<20;grid_zone_idx++){a=
z[grid_zone_idx];try{result=this.toLonLat(d%60+a+b+l);arc_distance=this.llDistance(e,result);if(arc_distance<n){n=arc_distance;g=d%60;j=a}}catch(p){}}if(g&&j){d=g;a=j}else throw"USNG: Couldn't find a match";}else if(e){n=1E3;var q=j=g=null,s=Math.floor((e.lon- -180)/6)+1,A=Math.floor((e.lat- -80)/8);for(d=s-1;d<=s+1;d++)for(grid_zone_idx=A-1;grid_zone_idx<=A+1;grid_zone_idx++){a=z[grid_zone_idx];var t,u;switch(d%6){case 1:t=h;u=r;break;case 2:t=k;u=v;break;case 3:t=h;u=w;break;case 4:t=k;u=r;break;
case 5:t=h;u=v;break;case 0:t=k;u=w;break;default:throw"Can't get here";}for(ns_idx=0;ns_idx<20;ns_idx++)for(ew_idx=0;ew_idx<8;ew_idx++)try{b=u[ew_idx]+t[ns_idx];result=this.toLonLat(d%60+a+b+l);arc_distance=this.llDistance(e,result);if(arc_distance<n){n=arc_distance;g=d%60;j=a;q=b}}catch(B){}}if(g&&j){d=g;a=j;b=q}else throw"USNG: Couldn't find a match";}else throw"USNG: Not enough information to locate point.";return this.toUTMFromFullParsedUSNG(d,a,b,f,m,o)};this.fromLonLat=function(c,e){usng_string=
new String;for(var f=c.lon,m=c.lat;f<-180;)f+=180;for(;f>180;)f-=180;utm_zone=Math.floor((f- -180)/6)+1;if(!(m>-80&&m<80))throw"USNG: Latitude must be between -80 and 80. (Zones A and B are not implemented yet.)";var o=z[Math.floor((m- -80)/8)];f=utm_proj.proj(utm_zone,f,m);return this.fromUTM(utm_zone,o,f.utm_easting,f.utm_northing,e)};this.toLonLat=function(c,e){result=this.toUTM(c,e);ll=utm_proj.invProj(result.zone,result.easting,result.northing);ll.precision=result.precision;return ll};this.UTM=
function(){var c=(40680631590769-6356752.3*6356752.3)/40680631590769,e=c/(1-c),f=c*c,m=c*f,o=Math.PI/180;this.proj=function(l,b,a){var d=a*o,n=Math.sin(d),g=Math.cos(d);a=n/g;var j=a*a,p=j*j;n=6378137/Math.sqrt(1-c*n*n);var q=e*g*g;b=g*(b*o- -((30-l)*6+3)*o);d=6378137*(1-c/4-3*f/64-5*m/256)*d+-6378137*(3*c/8+3*f/32+45*m/1024)*Math.sin(d*2)+6378137*(15*f/256+45*m/1024)*Math.sin(d*4)+-223234795*m/3072*Math.sin(d*6);g=Math.pow(b,5);x=0.9996*n*(b+(1-j+q)*Math.pow(b,3)/6+(5-18*j+p+72*q-58*e)*g/120)+5E5;
y=0.9996*(d+n*a*(b*b/2+(5-j+9*q+4*q*q)*Math.pow(b,4)/24+(61-58*j+p+600*q-330*e)*(g*b/720)));return{utm_zone:l,utm_easting:x,utm_northing:y}};this.invProj=function(l,b,a){l=-((30-l)*6+3)*o;var d=Math.sqrt(1-c),n=(1-d)/(1+d),g=n*n,j=n*g;b-=5E5;a=a/0.9996/(6378137*(1-c/4-3*(f/64)-5*(m/256)));a=a+(1.5*n-0.84375*j)*Math.sin(2*a)+(1.3125*g-1.71875*g*g)*Math.sin(4*a)+151*j/96*Math.sin(6*a);var p=Math.sin(a);n=Math.cos(a);d=p/n;var q=6378137/Math.sqrt(1-c*p*p);g=d*d;j=e*n*n;p=1-c*p*p;b/=q*0.9996;var s=b*
b,A=b*s,t=s*s,u=g*g,B=j*j;d=q*d/(6378137*(1-c)/Math.sqrt(p*p*p));temp2=5+3*g+10*j-4*B-9*e;temp4=61+90*g+298*j+45*u-252*e-3*B;temp5=(1+2*g+j)*A/6;temp6=5-2*j+28*g-3*B+8*e+24*u;lat=(a-d*(s/2-temp2*(t/24)+temp4*A*A/720))*180/Math.PI;lon=(l+(b-temp5+temp6*b*t/120)/n)*180/Math.PI;return{lon:lon,lat:lat}}};utm_proj=new this.UTM}
OpenLayers.Control.MGRSMousePosition=OpenLayers.Class(OpenLayers.Control,{element:null,prefix:"",separator:", ",suffix:"",numDigits:5,granularity:10,lastXy:null,displayProjection:null,initialize:function(){OpenLayers.Control.prototype.initialize.apply(this,arguments)},destroy:function(){this.map&&this.map.events.unregister("mousemove",this,this.redraw);OpenLayers.Control.prototype.destroy.apply(this,arguments)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments);if(!this.element){this.div.left=
"";this.div.top="";this.element=this.div}this.redraw();return this.div},redraw:function(h){var k;if(h==null)k=new OpenLayers.LonLat(0,0);else{if(this.lastXy==null||Math.abs(h.xy.x-this.lastXy.x)>this.granularity||Math.abs(h.xy.y-this.lastXy.y)>this.granularity){this.lastXy=h.xy;return}k=this.map.getLonLatFromPixel(h.xy);if(!k)return;this.displayProjection&&k.transform(this.map.getProjectionObject(),this.displayProjection);this.lastXy=h.xy}h=this.formatOutput(k);if(h!=this.element.innerHTML)this.element.innerHTML=
h},formatOutput:function(h){var k=OpenLayers.INCHES_PER_UNIT;k=this.map.getResolution()*k[this.map.getUnits()]*(1/k.m);var r=parseInt(6-Math.ceil(Math.log(k)/2.302585092994046));k=parseInt(this.numDigits);var v=new USNG2;r=h.lat>-80&&h.lat<80?v.fromLonLat(h,r-1):"undefined";return this.prefix+h.lon.toFixed(k)+this.separator+h.lat.toFixed(k)+" / MGRS: "+r+this.suffix},setMap:function(){OpenLayers.Control.prototype.setMap.apply(this,arguments);this.map.events.register("mousemove",this,this.redraw)},
CLASS_NAME:"OpenLayers.Control.MousePosition"});
