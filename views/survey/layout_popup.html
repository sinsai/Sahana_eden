<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
{{if session.s3.debug:}}
  {{include "sahana_styles_debug.html"}}
  {{include "sahana_scripts_debug.html"}}
{{else:}}
  <link href="/{{=request.application}}/static/styles/S3/sahana.min.css" rel="stylesheet" type="text/css" media="screen" charset="utf-8" />
  {{include "sahana_scripts_min.html"}}
{{pass}}
{{include "colorbox.html"}}

<script type="text/javascript">//<![CDATA[

$(document).ready( function() {
    // Reset the parent's toggle
    self.parent.window.togglecallerappend = "True";
});

function TB_cleanup(caller) {
    if(self.parent.cleanup)
       self.parent.cleanup(caller);
    self.parent.tb_remove();
}

function TB_refresh() {
    // URL to retrieve the Options list for the field of the master resource
    var url = '{{=URL(r=request, c="survey", f="template_link_table")}}';
    url += "/options.json?field=survey_question_id"
    var selector = self.parent.$('#survey_question_id');
    var selected_values = selector.selectedValues(); 
    var options = self.parent.$('#survey_question_id *');
    var dropdown = options.length
    if ( dropdown ) {
        var append={}
    }
    var value_high = 1;
    var represent_high = "";
    $.getJSONS3(url, function (data) {
        var value, represent;
        $.each(data['option'], function() {
            value = this['@value'];
            represent = this['$'];
            if(typeof represent === "undefined") {
                represent = "";
            }
            if(value == "") {
                return;
            }
            if (dropdown) {
                options.remove();
                append[value] = represent;
            }
            // Type conversion: http://www.jibbering.com/faq/faq_notes/type_convert.html#tcNumber
            numeric_value = (+value)
            if (numeric_value > value_high) {
                value_high = numeric_value;
                represent_high = represent;
            }
        });
        if (dropdown) {
            // We have been called next to a drop-down
            // Clean up the caller
            selector.addOption(append,false).change();
        }
        // IE6 needs time for DOM to settle: http://csharperimage.jeremylikness.com/2009/05/jquery-ie6-and-could-not-set-selected.html
        setTimeout(function() {
            // Set the newly-created value (one with highest value) retaining selected values.
            selected_values.push(value_high);
            selector.selectOptions(selected_values,false).change();            
            }, 1);
        // Clean-up
        TB_cleanup("survey_question_id");
    });
}
// Function to get the URL parameters
function getQueryParams(qs) {
// We want all the vars, i.e. after the ?
    qs = qs.split('?')[1]
    var pairs = qs.split('&');
    var params = {};
    var check = [];
    for( var i = 0; i < pairs.length; i++ ) {
            check = pairs[i].split('=');
            params[decodeURIComponent(check[0])] = decodeURIComponent(check[1]);
        }
    return params;
}

// If submission succesful
{{if response.flash or response.confirmation:}}
// Refresh the DIV and close the pop up
$(document).ready( function() {
        self.parent.$(".TB_closeAjaxWindow").html('');
    });
TB_refresh();
{{pass}}

//]]></script>

</head>

<body>
{{if response.flash or response.confirmation:}}
    <div id='popup' class='clearfix'>
        <p style='padding:20px 20px;'>
            <center>
                <h2>
                    {{=T("Submission successful - please wait...")}}
                </h2>
            </center>
        <p>
    </div>
{{else:}}
    {{include}}
{{pass}}
</body>
</html>
